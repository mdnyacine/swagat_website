const postcss = require('postcss');
const fs = require('fs');
const harmonizePath = require.resolve('harmonize.css/harmonize.css');

/**
 * init
 *
 * @since 2.1.0
 *
 * @return callback to harmonize styles
 */

function init()
{
	return styles =>
	{
		return new Promise((resolve, reject) =>
		{
			fs.readFile(harmonizePath, 'utf8', (error, data) =>
			{
				if (error)
				{
					reject(error);
				}
				else
				{
					resolve(data);
				}
			});
		})
		.then(data =>
		{
			return postcss.parse(data,
			{
				from: harmonizePath
			});
		})
		.then(harmonizeRoot =>
		{
			styles.prepend(harmonizeRoot);
		});
	};
}

module.exports = postcss.plugin('postcss-harmonize', init);
